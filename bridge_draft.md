# チャンネルブリッジ機能 要件ドラフト

- **機能概要**: Bot起動中のみ有効なメッセージ転送機能を提供し、指定されたチャンネル間で本文・添付・リアクションを同期する。元メッセージと転送メッセージのID対応は揮発メモリで管理し、取得不能や削除に応じてクリーンアップする。
- **ルーティング設定**: `data/channel_routes.json`（仮）に `{"src": {"guild": <int>, "channel": <int>}, "dst": {"guild": <int>, "channel": <int>}}` 形式のペアを列挙し、Bot起動時にのみ読み込む。ファイル未存在時はサンプルを自動生成して案内する。
- **プロフィール装飾**: メッセージ送信者は DiceBear Avatar API（`https://api.dicebear.com/9.x/bottts-neutral/svg?scale=80`）を用いた擬似プロフィールで装飾。転送ごとにシードを決めて URL を生成し、サービスの利用規約・レート制限を遵守する。API障害時はBot既定アイコンへフォールバックする。
- **ランダム名称生成**: 形容詞120語・名詞200語程度の辞書を独自に用意し、TinyDBへ格納。転送時は「形容詞+一般名詞」の組み合わせで日本語表示名を生成し、DiceBearのシードと連動させる。
- **メディア転送方針**: Embed化できない添付は本文に `(画像)` などの簡易プレースホルダーや元メッセージの直リンクを追記し、情報欠落を避ける。画像1件はEmbed化、それ以降は添付として送付。
- **イベント連携**: `BotClient` にブリッジ用マネージャを注入し、`on_message` / `on_reaction_add` / `on_reaction_remove` から呼び出す。既存機能（VC管理等）と干渉しないよう条件分岐を明示する。
- **エラーハンドリング**: 取得不可能なチャンネルやDiscord API例外を検出した際はログに警告出力、必要なら後続の通知機構を差し込める設計とする。
- **開発運用**: ログは `print` による標準出力のみを想定し、初期実装段階では自動テストは導入しない。
- **拡張ポイント**: 将来的にルーティング再読み込みやプロフィールセット差し替えを想定し、設定読み込みロジックを単独モジュールへ切り出す余地を残す。
- **Embed非対応時の処理**:
  - 画像添付は先頭のみEmbed表示、2枚目以降や非画像添付は本文に種類ラベル（例: `(画像)` `(動画)` `(ファイル)`）と直リンクを追加する。
  - 添付の取得に失敗した場合は本文へ `(添付取得失敗: ファイル名)` を記録し、ログへエラーを出力してマッピングを整理する。
  - 長文でEmbed説明の文字数制限を超える場合、通常メッセージ送信へフォールバックし、DiceBear生成名をテキストで表現する。
  - ステッカーや返信は本文に `(ステッカー: 名称)` や `▶ Reply to <jump_url>` を追記して参照先を明示する。
  - DiceBearの生成に失敗した場合はBot既定アイコンに切り替え、本文へ `(DiceBear生成失敗)` を添える。
- **データスキーマ素案**:
  - `data/channel_routes.json`: `List[{"src": {"guild": int, "channel": int}, "dst": {"guild": int, "channel": int}}]`
  - TinyDB `bridge_profiles` テーブル: `{"id": str, "adjectives": List[str], "nouns": List[str], "updated_at": ISO8601 str}` を1レコード保持
  - 揮発メッセージマップ: `Dict[int, int]` をメモリ上に保持し、双方向登録
  - DiceBearプロフィール生成用のメタ情報: `NamedTuple` または `dataclass` で `seed: str`, `display_name: str`, `avatar_url: str`, `source_message_id: int` を管理
